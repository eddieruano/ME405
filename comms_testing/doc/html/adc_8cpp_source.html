<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Lab0 A/D Converter: adc.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>adc.cpp</h1><a href="adc_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//*************************************************************************************</span><span class="comment"></span>
<a name="l00002"></a>00002 <span class="comment">/** @file adc.cpp</span>
<a name="l00003"></a>00003 <span class="comment"> *    This file contains a very simple A/D converter driver. This driver should be</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> *  Revisions:</span>
<a name="l00006"></a>00006 <span class="comment"> *    @li 01-15-2008 JRR Original (somewhat useful) file</span>
<a name="l00007"></a>00007 <span class="comment"> *    @li 10-11-2012 JRR Less original, more useful file with FreeRTOS mutex added</span>
<a name="l00008"></a>00008 <span class="comment"> *    @li 10-12-2012 JRR There was a bug in the mutex code, and it has been fixed</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> *  License:</span>
<a name="l00011"></a>00011 <span class="comment"> *    This file is copyright 2015 by JR Ridgely and released under the Lesser GNU </span>
<a name="l00012"></a>00012 <span class="comment"> *    Public License, version 2. It intended for educational use only, but its use</span>
<a name="l00013"></a>00013 <span class="comment"> *    is not limited thereto. */</span>
<a name="l00014"></a>00014 <span class="comment">/*    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; </span>
<a name="l00015"></a>00015 <span class="comment"> *    AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE </span>
<a name="l00016"></a>00016 <span class="comment"> *    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE </span>
<a name="l00017"></a>00017 <span class="comment"> *    ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE </span>
<a name="l00018"></a>00018 <span class="comment"> *    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUEN-</span>
<a name="l00019"></a>00019 <span class="comment"> *    TIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS </span>
<a name="l00020"></a>00020 <span class="comment"> *    OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER </span>
<a name="l00021"></a>00021 <span class="comment"> *    CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, </span>
<a name="l00022"></a>00022 <span class="comment"> *    OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE </span>
<a name="l00023"></a>00023 <span class="comment"> *    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. */</span>
<a name="l00024"></a>00024 <span class="comment">//*************************************************************************************</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>                         <span class="comment">// Include standard library header files</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;avr/io.h&gt;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;rs232int.h&quot;</span>                       <span class="comment">// Include header for serial port class</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="adc_8h.html">adc.h</a>&quot;</span>                            <span class="comment">// Include header for the A/D class</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="comment">//-------------------------------------------------------------------------------------</span><span class="comment"></span>
<a name="l00034"></a>00034 <span class="comment">/** @brief This constructor sets up an A/D converter. </span>
<a name="l00035"></a>00035 <span class="comment"> *  @details This constructor takes the pointer given to it and initializes itself. Also, here we set the voltage refrence and enable the A/D converter as well as set the prescaler to 32, through some bitshifting.</span>
<a name="l00036"></a>00036 <span class="comment"> *  @param p_serial_port A pointer to the serial port which writes debugging info. </span>
<a name="l00037"></a>00037 <span class="comment"> */</span>
<a name="l00038"></a>00038 
<a name="l00039"></a><a class="code" href="classadc.html#af3b8262c08f5fc5ae325a20622883424">00039</a> <a class="code" href="classadc.html#af3b8262c08f5fc5ae325a20622883424" title="This constructor sets up an A/D converter.">adc::adc</a> (emstream* p_serial_port)
<a name="l00040"></a>00040 {
<a name="l00041"></a>00041     <a class="code" href="classadc.html#a14680b48b723bf1adddd2741ebb18a3e" title="The ADC class uses this pointer to the serial port to say hello.">ptr_to_serial</a> = p_serial_port;
<a name="l00042"></a>00042 
<a name="l00043"></a>00043     <span class="comment">//enables voltage refrence AVCC and sets AREF</span>
<a name="l00044"></a>00044     ADMUX |= 1 &lt;&lt; REFS0;  external capacitor
<a name="l00045"></a>00045     <span class="comment">// enable + set the prescaler to 32</span>
<a name="l00046"></a>00046     ADCSRA |= ((1&lt;&lt;ADEN)|(1&lt;&lt;ADSC)|(1&lt;&lt;ADPS2)|(1&lt;&lt;ADPS0));
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 
<a name="l00049"></a>00049     <span class="comment">// Print a handy debugging message</span>
<a name="l00050"></a>00050     DBG (<a class="code" href="classadc.html#a14680b48b723bf1adddd2741ebb18a3e" title="The ADC class uses this pointer to the serial port to say hello.">ptr_to_serial</a>, <span class="stringliteral">&quot;A/D constructor OK&quot;</span> &lt;&lt; endl);
<a name="l00051"></a>00051 }
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="comment">//-------------------------------------------------------------------------------------</span><span class="comment"></span>
<a name="l00055"></a>00055 <span class="comment">/** @brief   This method takes one A/D reading from the given channel and returns it. </span>
<a name="l00056"></a>00056 <span class="comment"> *  @details Given a channel, this method first checks to make sure only valid channels are accepted by setting any outside parameter to channel 0. Then we set the correct register to enable the A/D and use a while loop to wait until the completion bit is 0. At that point, the loop breaks and the results stored in ADCL and ADCH are concatenated into the 16 bit return value.</span>
<a name="l00057"></a>00057 <span class="comment"> *  @param   ch The A/D channel which is being read must be from 0 to 7</span>
<a name="l00058"></a>00058 <span class="comment"> *  @return  ADC_value, the 16 bit returned value of the concatendated High and Low results.</span>
<a name="l00059"></a>00059 <span class="comment"> */</span>
<a name="l00060"></a>00060 
<a name="l00061"></a><a class="code" href="classadc.html#a2190a59696a7093e1ea605e998ccf97e">00061</a> uint16_t <a class="code" href="classadc.html#a2190a59696a7093e1ea605e998ccf97e" title="This method takes one A/D reading from the given channel and returns it.">adc::read_once</a> (uint8_t ch)
<a name="l00062"></a>00062 {
<a name="l00063"></a>00063     <span class="comment">//result init</span>
<a name="l00064"></a>00064     uint16_t ADC_value = 0;
<a name="l00065"></a>00065 
<a name="l00066"></a>00066     <span class="comment">//channel entry valid check</span>
<a name="l00067"></a>00067     <span class="keywordflow">if</span>(ch &gt; 7){ ch = 0; }
<a name="l00068"></a>00068     <span class="comment">//clear the mux reg we&apos;re sure that it starts at 000</span>
<a name="l00069"></a>00069     ADMUX &amp;= ~(7&lt;&lt;MUX0);
<a name="l00070"></a>00070     <span class="comment">//set the mux</span>
<a name="l00071"></a>00071     ADMUX |= ch&lt;&lt;MUX0;
<a name="l00072"></a>00072     <span class="comment">//begin the converstion</span>
<a name="l00073"></a>00073     ADCSRA |= 1&lt;&lt;ADSC; 
<a name="l00074"></a>00074     <span class="comment">// Wait until ADSC is zero</span>
<a name="l00075"></a>00075     <span class="keywordflow">while</span> () 
<a name="l00076"></a>00076     {
<a name="l00077"></a>00077         <span class="keywordflow">if</span>(!(ADCSRA &amp; 1&lt;&lt;ADSC))
<a name="l00078"></a>00078         {
<a name="l00079"></a>00079             <span class="keywordflow">break</span>;
<a name="l00080"></a>00080         }
<a name="l00081"></a>00081     }
<a name="l00082"></a>00082 
<a name="l00083"></a>00083     <span class="comment">//combine the high and low bits using casting technique shown in class</span>
<a name="l00084"></a>00084     ADC_value = ((uint16_t) ADCL | (uint16_t) ADCH&lt;&lt;8);
<a name="l00085"></a>00085     <span class="keywordflow">return</span> ADC_value;
<a name="l00086"></a>00086 }
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="comment">//-------------------------------------------------------------------------------------</span><span class="comment"></span>
<a name="l00090"></a>00090 <span class="comment">/** @brief   This method takes multiple readings specified by an input parameter from a particular channel and return the average of those readings.</span>
<a name="l00091"></a>00091 <span class="comment"> *  @param   channel this parameter specifies which channel we&apos;re going to be averaging</span>
<a name="l00092"></a>00092 <span class="comment"> *  @param   samples this specifies how many samples we&apos;re going to be taking and serves as the basis for our average division.</span>
<a name="l00093"></a>00093 <span class="comment"> *  @return  average_result, this is the average value read over that channel per those samples.</span>
<a name="l00094"></a>00094 <span class="comment"> */</span>
<a name="l00095"></a>00095 
<a name="l00096"></a><a class="code" href="classadc.html#a58f1030fe64d3dea4ccd8a2687dd6fce">00096</a> uint16_t <a class="code" href="classadc.html#a58f1030fe64d3dea4ccd8a2687dd6fce" title="This method takes multiple readings specified by an input parameter from a particular...">adc::read_oversampled</a> (uint8_t channel, uint8_t samples)
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098     <span class="comment">// DBG (ptr_to_serial, &quot;All your readings are belong to us&quot; &lt;&lt; endl);</span>
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     <span class="comment">// 16 bits for the average result </span>
<a name="l00101"></a>00101     uint16_t total_result;
<a name="l00102"></a>00102     uint8_t average_result;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     <span class="comment">//setting the limit to not overflow our 16 bit variable</span>
<a name="l00105"></a>00105     <span class="keywordflow">if</span>(samples &gt; 64){ samples = 64; }
<a name="l00106"></a>00106 
<a name="l00107"></a>00107     <span class="comment">//sum the values of each channel read over the entire sample area</span>
<a name="l00108"></a>00108     <span class="keywordflow">for</span>(uint8_t i=0; i &lt; samples; i++)
<a name="l00109"></a>00109     {
<a name="l00110"></a>00110         <span class="comment">// Read and add</span>
<a name="l00111"></a>00111         total_result += <a class="code" href="classadc.html#a2190a59696a7093e1ea605e998ccf97e" title="This method takes one A/D reading from the given channel and returns it.">read_once</a>(channel); 
<a name="l00112"></a>00112     }
<a name="l00113"></a>00113 
<a name="l00114"></a>00114     <span class="comment">//calculate the average</span>
<a name="l00115"></a>00115     average_result = total_result / samples;
<a name="l00116"></a>00116     <span class="keywordflow">return</span> average_result;
<a name="l00117"></a>00117     
<a name="l00118"></a>00118 }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="comment">//-------------------------------------------------------------------------------------</span><span class="comment"></span>
<a name="l00122"></a>00122 <span class="comment">/** \brief   This overloaded operator &quot;prints the A/D converter.&quot; </span>
<a name="l00123"></a>00123 <span class="comment"> *  \details The precise meaning of print is left to the user to interpret; it should </span>
<a name="l00124"></a>00124 <span class="comment"> *           be something useful. For example, one might print the values of the </span>
<a name="l00125"></a>00125 <span class="comment"> *           configuration registers or show current readings from all the A/D </span>
<a name="l00126"></a>00126 <span class="comment"> *           channels.</span>
<a name="l00127"></a>00127 <span class="comment"> *  @param   serpt Reference to a serial port to which the printout will be printed</span>
<a name="l00128"></a>00128 <span class="comment"> *  @param   a2d   Reference to the A/D driver which is being printed</span>
<a name="l00129"></a>00129 <span class="comment"> *  @return  A reference to the same serial device on which we write information.</span>
<a name="l00130"></a>00130 <span class="comment"> *           This is used to string together things to write with @c &lt;&lt; operators</span>
<a name="l00131"></a>00131 <span class="comment"> */</span>
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="adc_8h.html#a6e6d1e227b216fe2a1fee9b0ea52180d">00133</a> emstream&amp; <a class="code" href="adc_8cpp.html#afb33ca9fe94765ee57079e7feb03f975" title="This overloaded operator &amp;quot;prints the A/D converter.&amp;quot;.">operator &lt;&lt; </a>(emstream&amp; serpt, <a class="code" href="classadc.html" title="This class will run the A/D converter on an AVR processor.">adc</a>&amp; a2d)
<a name="l00134"></a>00134 {
<a name="l00135"></a>00135     <span class="comment">// Prints info to the serial port</span>
<a name="l00136"></a>00136     serpt &lt;&lt; PMS (<span class="stringliteral">&quot;The A/D Converter Values&quot;</span>)&lt;&lt;endl 
<a name="l00137"></a>00137           &lt;&lt; PMS (<span class="stringliteral">&quot;ADMUX value: &quot;</span>)&lt;&lt; bin &lt;&lt; ADMUX &lt;&lt; dec &lt;&lt; endl
<a name="l00138"></a>00138           &lt;&lt; PMS (<span class="stringliteral">&quot;ADCSRA value: &quot;</span>)&lt;&lt; bin&lt;&lt; ADCSRA &lt;&lt; dec &lt;&lt; endl
<a name="l00139"></a>00139           &lt;&lt; PMS (<span class="stringliteral">&quot;Average result channel 0: &quot;</span>)&lt;&lt; a2d.<a class="code" href="classadc.html#a58f1030fe64d3dea4ccd8a2687dd6fce" title="This method takes multiple readings specified by an input parameter from a particular...">read_oversampled</a> (0, 10) &lt;&lt; endl
<a name="l00140"></a>00140           &lt;&lt; PMS (<span class="stringliteral">&quot;Average result channel 1: &quot;</span>)&lt;&lt; a2d.<a class="code" href="classadc.html#a58f1030fe64d3dea4ccd8a2687dd6fce" title="This method takes multiple readings specified by an input parameter from a particular...">read_oversampled</a> (1, 10) &lt;&lt; endl;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     <span class="keywordflow">return</span> (serpt);
<a name="l00143"></a>00143 }
<a name="l00144"></a>00144 
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 7 Apr 2016 for Lab0 A/D Converter by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
